import React, { FC, useCallback, useEffect, useState } from "react";
import axios, { AxiosResponse } from "axios";

// Use environment API base if provided, otherwise default to local backend
const API_BASE =
  (import.meta as any)?.env?.VITE_API_URL ?? "https://billingbackend-1vei.onrender.com";

type ID = string | number;

interface Customer {
  id?: ID;
  name?: string;
  phone?: string;
  email?: string;
  address?: string;
  alternate_phone?: string;
  alternatePhone?: string;
  is_active?: boolean;
  isActive?: boolean;
  [key: string]: any;
}

interface ApiListResponse {
  success?: boolean;
  data?: Customer[] | any;
  total?: number;
  [key: string]: any;
}

interface ApiSingleResponse {
  success?: boolean;
  data?: Customer | any;
  [key: string]: any;
}

interface CustomerForm {
  name: string;
  phone: string;
  email: string;
  address: string;
  alternatePhone: string;
  isActive: boolean;
}

const initialForm: CustomerForm = {
  name: "",
  phone: "",
  email: "",
  address: "",
  alternatePhone: "",
  isActive: true,
};

const normalizeFromServer = (data: Customer): Customer => ({
  id: data.id,
  name: data.name ?? "",
  phone: data.phone ?? "",
  email: data.email ?? "",
  address: data.address ?? "",
  alternatePhone: data.alternatePhone ?? data.alternate_phone ?? "",
  isActive: data.isActive ?? data.is_active ?? true,
});

const toPayload = (form: CustomerForm) => {
  // Send keys in snake_case if backend expects that.
  return {
    name: form.name || undefined,
    phone: form.phone || undefined,
    email: form.email || undefined,
    address: form.address || undefined,
    alternate_phone: form.alternatePhone || undefined,
    is_active: form.isActive,
  };
};

const CustomerPage: FC = () => {
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [total, setTotal] = useState<number>(0);
  const [q, setQ] = useState<string>("");
  const [page, setPage] = useState<number>(1);
  const limit = 20;

  const [modalOpen, setModalOpen] = useState<boolean>(false);
  const [editingId, setEditingId] = useState<ID | null>(null);

  const [form, setForm] = useState<CustomerForm>(initialForm);
  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [saving, setSaving] = useState<boolean>(false);
  const [loadingList, setLoadingList] = useState<boolean>(false);

  const fetchCustomers = useCallback(
    async (pageToLoad = page) => {
      setLoadingList(true);
      try {
        let resp: AxiosResponse<ApiListResponse> | AxiosResponse<any>;
        if (q && q.trim().length > 0) {
          resp = await axios.get(
            `${API_BASE}/api/customers/search/${encodeURIComponent(q)}`
          );
        } else {
          resp = await axios.get(`${API_BASE}/api/customers`, {
            params: { page: pageToLoad, limit },
          });
        }
        const payload: ApiListResponse = resp?.data ?? {};
        const list: Customer[] = Array.isArray(payload.data)
          ? payload.data.map((d) => normalizeFromServer(d))
          : Array.isArray(payload)
          ? (payload as unknown as Customer[]).map((d) =>
              normalizeFromServer(d)
            )
          : [];

        setCustomers(list || []);
        setTotal(
          typeof payload.total === "number" ? payload.total : list.length
        );
      } catch (err) {
        console.error("Failed to load customers", err);
      } finally {
        setLoadingList(false);
      }
    },
    [q, page]
  );

  useEffect(() => {
    fetchCustomers(page);
  }, [fetchCustomers, page]);

  // Debounce search input: automatically trigger search when `q` changes
  useEffect(() => {
    const t = setTimeout(() => {
      setPage(1);
      fetchCustomers(1);
    }, 400);
    return () => clearTimeout(t);
    // intentionally only watching q and fetchCustomers
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [q]);

  useEffect(() => {
    const token = localStorage.getItem("auth_token");
    if (token)
      axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;
  }, []);

  const openCreate = () => {
    setEditingId(null);
    setFormErrors({});
    // Prefill with sample data from screenshot; replace with `initialForm` for blank.
    setForm({
      ...initialForm,
      name: "Arun Kumar",
      phone: "9876543210",
      email: "arun@example.com",
      address: "Kakkanad, Kochi",
      alternatePhone: "9123456780",
      isActive: true,
    });
    setModalOpen(true);
  };

  const openEdit = async (id: ID) => {
    setEditingId(id);
    setFormErrors({});
    try {
      const resp: AxiosResponse<ApiSingleResponse> = await axios.get(
        `${API_BASE}/api/customers/${id}`
      );
      const data: Customer = resp?.data?.data ?? resp?.data ?? {};
      const normalized = normalizeFromServer(data);
      setForm({
        name: normalized.name ?? "",
        phone: normalized.phone ?? "",
        email: normalized.email ?? "",
        address: normalized.address ?? "",
        alternatePhone: normalized.alternatePhone ?? "",
        isActive: normalized.isActive ?? true,
      });
      setModalOpen(true);
    } catch (err) {
      console.error("Failed to load customer", err);
    }
  };

  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};
    if (!form.name || !form.name.trim()) errors.name = "Name is required";
    if (!form.phone || !form.phone.trim()) errors.phone = "Phone is required";
    if (form.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email))
      errors.email = "Invalid email";
    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;
    setSaving(true);
    try {
      const payload = toPayload(form);
      if (editingId) {
        await axios.put(`${API_BASE}/api/customers/${editingId}`, payload);
      } else {
        await axios.post(`${API_BASE}/api/customers`, payload);
      }
      setModalOpen(false);
      setEditingId(null);
      setForm(initialForm);
      setPage(1);
      await fetchCustomers(1);
    } catch (err: any) {
      console.error("Save failed", err);
      const serverErr = err?.response?.data ?? err?.response ?? null;
      if (serverErr && typeof serverErr === "object") {
        setFormErrors((prev) => ({
          ...prev,
          ...(serverErr.errors || serverErr),
        }));
      } else if (serverErr) {
        setFormErrors((prev) => ({ ...prev, general: String(serverErr) }));
      } else {
        setFormErrors((prev) => ({ ...prev, general: "Save failed" }));
      }
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id: ID) => {
    const ok = window.confirm("Are you sure you want to delete this customer?");
    if (!ok) return;
    try {
      await axios.delete(`${API_BASE}/api/customers/${id}`);
      fetchCustomers();
    } catch (err) {
      console.error("Delete failed", err);
      alert("Delete failed. Check console.");
    }
  };

  const handleActivate = async (id: ID) => {
    try {
      await axios.put(`${API_BASE}/api/customers/${id}`, {
        is_active: true,
        status: "active",
      });
      // optimistically update local state by refetching current page
      await fetchCustomers(page);
      window.alert("Customer activated");
    } catch (err) {
      console.error("Activate failed", err);
      alert("Activate failed. Check console.");
    }
  };

  const gotoPrev = () => setPage((p) => Math.max(1, p - 1));
  const gotoNext = () => setPage((p) => p + 1);

  return (
    <div className="p-6">
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-2xl font-semibold">Customers</h1>
          <p className="text-sm text-gray-600">Manage customer records.</p>
        </div>

        <div className="flex items-center space-x-3">
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Enter") {
                setPage(1);
                fetchCustomers(1);
              }
            }}
            placeholder="Search customers..."
            className="border rounded px-3 py-2 w-72"
          />
          <button
            onClick={() => {
              setPage(1);
              fetchCustomers(1);
            }}
            className="px-3 py-2 border rounded bg-white"
          >
            Search
          </button>
          <button
            onClick={openCreate}
            className="px-4 py-2 bg-blue-600 text-white rounded"
          >
            + Add Customer
          </button>
        </div>
      </div>

      <div className="mt-6 bg-white rounded shadow p-4">
        <div className="flex justify-between items-center mb-4">
          <div className="text-lg font-semibold">Customers ({total})</div>
          <div className="text-sm text-gray-500">
            {loadingList ? "Loading…" : `Page ${page}`}
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full table-auto">
            <thead>
              <tr className="text-left text-sm text-gray-600 border-b">
                <th className="py-2">Name</th>
                <th className="py-2">Phone</th>
                <th className="py-2">Email</th>
                <th className="py-2">Address</th>
                <th className="py-2">Alternate Phone</th>
                <th className="py-2">Active</th>
                <th className="py-2 text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {customers.map((c) => (
                <tr
                  key={String(c.id ?? Math.random())}
                  className="border-b hover:bg-gray-50"
                >
                  <td className="py-3 font-medium">{c.name ?? "—"}</td>
                  <td className="py-3">{c.phone ?? "—"}</td>
                  <td className="py-3 text-xs text-gray-500">
                    {c.email ?? "—"}
                  </td>
                  <td className="py-3">{c.address ?? "—"}</td>
                  <td className="py-3">
                    {c.alternatePhone ?? c.alternate_phone ?? "—"}
                  </td>
                  <td className="py-3">
                    {c.isActive ?? c.is_active ? "TRUE" : "FALSE"}
                  </td>
                  <td className="py-3 text-right">
                    <div className="inline-flex items-center space-x-2">
                      <button
                        onClick={() => openEdit(c.id ?? "")}
                        className="px-2 py-1 border rounded text-sm"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => handleDelete(c.id ?? "")}
                        className="px-2 py-1 border rounded text-sm text-red-600"
                      >
                        Delete
                      </button>
                      {!(c.isActive ?? c.is_active) && (
                        <button
                          onClick={() => handleActivate(c.id ?? "")}
                          className="px-2 py-1 border rounded text-sm text-green-700"
                        >
                          Activate
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              ))}

              {customers.length === 0 && (
                <tr>
                  <td colSpan={7} className="py-6 text-center text-gray-500">
                    No customers found.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        <div className="mt-4 flex items-center justify-between">
          <div className="text-sm text-gray-600">
            Showing {customers.length} of {total}
          </div>
          <div className="space-x-2">
            <button
              onClick={gotoPrev}
              disabled={page === 1}
              className="px-3 py-1 border rounded disabled:opacity-50"
            >
              Prev
            </button>
            <button onClick={gotoNext} className="px-3 py-1 border rounded">
              Next
            </button>
          </div>
        </div>
      </div>

      {/* Modal */}
      {modalOpen && (
        <div className="fixed inset-0 z-50 flex items-start justify-center p-6 bg-black bg-opacity-40">
          <div className="bg-white w-full max-w-xl rounded shadow-lg">
            <div className="px-6 py-4 border-b flex justify-between items-center">
              <h3 className="text-lg font-semibold">
                {editingId ? "Edit Customer" : "Add Customer"}
              </h3>
              <button
                onClick={() => {
                  setModalOpen(false);
                  setEditingId(null);
                }}
                className="text-gray-600"
              >
                ✕
              </button>
            </div>

            <form onSubmit={handleSave} className="p-6 space-y-4">
              {formErrors.general && (
                <div className="text-red-600">{formErrors.general}</div>
              )}

              <div>
                <label className="block text-sm font-medium">Name *</label>
                <input
                  value={form.name}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, name: e.target.value }))
                  }
                  className="w-full border rounded px-3 py-2"
                />
                {formErrors.name && (
                  <div className="text-red-600 text-sm mt-1">
                    {formErrors.name}
                  </div>
                )}
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium">Phone</label>
                  <input
                    value={form.phone}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, phone: e.target.value }))
                    }
                    className="w-full border rounded px-3 py-2"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium">
                    Alternate Phone
                  </label>
                  <input
                    value={form.alternatePhone}
                    onChange={(e) =>
                      setForm((prev) => ({
                        ...prev,
                        alternatePhone: e.target.value,
                      }))
                    }
                    className="w-full border rounded px-3 py-2"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium">Email</label>
                <input
                  value={form.email}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, email: e.target.value }))
                  }
                  className="w-full border rounded px-3 py-2"
                />
                {formErrors.email && (
                  <div className="text-red-600 text-sm mt-1">
                    {formErrors.email}
                  </div>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium">Address</label>
                <textarea
                  value={form.address}
                  onChange={(e) =>
                    setForm((prev) => ({ ...prev, address: e.target.value }))
                  }
                  className="w-full border rounded px-3 py-2"
                  rows={3}
                />
              </div>

              <div className="flex items-center space-x-3">
                <label className="inline-flex items-center space-x-2">
                  <input
                    type="checkbox"
                    checked={form.isActive}
                    onChange={(e) =>
                      setForm((prev) => ({
                        ...prev,
                        isActive: e.target.checked,
                      }))
                    }
                    />
                  <span className="text-sm">Active</span>
                </label>
              </div>

              <div className="flex justify-end items-center space-x-3 pt-2">
                <button
                  type="button"
                  onClick={() => {
                    setModalOpen(false);
                    setEditingId(null);
                  }}
                  className="px-4 py-2 border rounded"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={saving}
                  className="px-6 py-2 bg-blue-600 text-white rounded"
                >
                  {saving ? "Saving…" : "Save"}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
};

export default CustomerPage;
